> 2021-12-23 初稿
# 关于Ecomon2
## Ecomon2要实现的三个程序
- 守护升级程序，支持U盘升级
   - 确认功能主程序心跳，根据需要决定重启主程序，还是要重启设备
   - 确认界面程序心跳
   - 主要功能包括：
      - U盘检查，文件拷贝，文件升级，文件清理
      - 启动主程序，通过运行脚本或其它方式
         - 检查主程序心跳，如果主程序要求重启设备，则重启设备
         - 如果主程序无心跳，则重启主程序
      - 启动界面程序
         - 检查界面程序心跳，
         - 如果界面程序要求重启设备，则重启设备
         - 如果界面程序要求重启主程序，则重启主程序
         - 如果界面程序无心跳，则重启界面程序
   - 主要涉及的技术点：
      - 磁盘检查，磁盘挂载、卸载
      - 文件操作
      - 运行其它进程
      - 监控其它进程
      - 关闭其它进程
      - 网络通讯
- 功能主程序，对外接口，主体功能
   - 主设备功能：485通讯，协议支持
   - 主设备功能：tcp通讯，协议支持
   - 主连接功能：tcp通讯，协议支持，Server模式
   - 辅助连接功能：Wifi通讯，提供第二种网络连接
   - 辅助连接功能：4G通讯，提供第三种网络连接
   - 辅助设备功能：Lora通讯，提供第四种网络连接，提供Lora访问设备
   - 数据功能：提供数据的存储，查询
   - 配置文件：提供配置文件的建立，修改，删除，增加，查询，协议支持
- 界面程序
   - 485功能界面
   - 网络通讯界面-设备端
   - 网络通讯界面-服务端
   - Wifi配置及状态界面
   - 4G配置及状态界面
   - Lora配置及状态界面
   - Debug界面
   - 数据及状态界面
   - 其它配置界面
   - Worker
      - 界面服务Worker
      - 心跳交互Worker
      - 功能交互Worker
# 关于界面程序
## 设计原则
- 界面程序是辅助性程序，不应当妨碍功能程序的运行，即使不运行界面程序，功能程序也应当可以正常运行。也即界面程序不应当有任何功能部分的设计，而应当致力于用户操作体验

## 界面程序基本结构
- 界面，只实现界面基本操作调用，功能部分由逻辑来实现
- 逻辑，实现界面功能，对接数据
- 数据，界面交互的目的
- 通讯，界面程序的对外接口，界面程序只通过通讯访问数据，而不直接访问任何底层或核心数据
   - 通讯数据应该是结构化的，便于解析，使用Json
   - 统一界面通讯协议格式
   - 可以接收推送数据，对接mqtt
   - 如果界面与功能间的交互可以通过web service的方式将是理想的，但是c++对web service支持的方式并不丰富

## 基本界面
- 登录界面
- 主界面
   - 配置界面
      - 485功能界面
      - Lora功能界面
      - 4G功能界面
      - Wifi功能界面
      - IOT
         - Mqtt
         - Web Service
         - SMS
   - 状态界面
      - Power Sensor状态
      - 连接状态
   - 数据界面
      - 列表方式
      - 图表方式
   - 控制界面 待定

# 关于功能程序
## 基本结构，使用目前前端存储的设计结构，大多数代码都是可以重用的

## 基本功能
- 连接部分（带着数据部分）
   - 485功能
   - Wifi功能
   - Lora功能
   - 4G功能
- 功能及状态部分
   - Power 功能及状态
- Worker部分

## 界面设计原则：（使用这种原则来重写4G服务程序，4G服务程序的界面应当和Ecomon2的界面存在某种共性）
- 界面只负责相关界面调用，并调用数据部分逻辑，和功能性逻辑
- 界面要有两个自定义信号，enter和quit，
   - enter用于初始化数据和Worker
   - quit用于退出worker，析构数据
   - 非界面功能，不允许写到界面内
- 数据部分逻辑包括：数据格式化，数据显示
- 功能部分逻辑包括但不限于：定时逻辑
   - 定时逻辑：产生定时事件，事件由界面逻辑和数据逻辑调用
      - 作为Worker类出现，需要一种逻辑就定义一种worker，界面本身是线程
      - 界面关闭，要退出worker
   - 如何清晰的表达逻辑和功能是界面主要的设计任务
   - 数据通过虚拟数据类调用，虚拟数据类提供update函数来更新数据，数据的更新逻辑根据需要设定
      - 如果需要实时数据，则定时自动调用
      - 如果不需要实时数据，则按需调用
      - 界面不会直接访问数据
   

- 设计2：（这种方式很难避免耦合，结构不够灵活，不采用）
   - 界面包含各种状态
      - 正常状态
      - 退出状态
      - 初始化状态
      - 每种状态去调用相应状态数据和逻辑
      - 需要增加其它状态，则添加相应状态类，每种状态包含数据和逻辑两部分

